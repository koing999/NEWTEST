<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì ê²½ì œì„± ë¶„ì„ ëŒ€ì‹œë³´ë“œ PRO Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans KR', sans-serif; }
        body { background: #0f172a; color: #e2e8f0; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
        }
        
        .sensitivity-table {
            font-size: 11px;
            border-collapse: collapse;
        }
        
        .sensitivity-table th, .sensitivity-table td {
            padding: 6px 10px;
            border: 1px solid #334155;
            text-align: center;
        }
        
        .sensitivity-positive { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .sensitivity-negative { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ê³ ì • ë†’ì´ */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .chart-container-small {
            position: relative;
            height: 250px;
            width: 100%;
        }
        
        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        .table-scroll::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-scroll::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        
        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1800px] mx-auto">
        <!-- í—¤ë” -->
        <div class="flex justify-between items-center mb-6 no-print">
            <h1 class="text-3xl font-bold text-blue-400">ğŸ’¼ íˆ¬ì ê²½ì œì„± ë¶„ì„ PRO Edition</h1>
            <div class="flex gap-3">
                <button onclick="toggleDarkMode()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition">
                    <i class="fas fa-moon"></i> ë‹¤í¬ëª¨ë“œ
                </button>
                <button onclick="downloadTemplate()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition">
                    <i class="fas fa-download"></i> í…œí”Œë¦¿
                </button>
                <button onclick="downloadExcel()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition">
                    <i class="fas fa-file-excel"></i> ì—‘ì…€
                </button>
                <button onclick="window.print()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg transition">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button onclick="shareResults()" class="px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-lg transition">
                    <i class="fas fa-share-alt"></i> ê³µìœ 
                </button>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <!-- ì™¼ìª½ ì…ë ¥ íŒ¨ë„ -->
            <div class="col-span-5 space-y-4">
                
                <!-- í”„ë¡œì íŠ¸ ê´€ë¦¬ -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">ğŸ“ í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>
                    <div class="flex gap-2">
                        <input type="text" id="project-name" placeholder="í”„ë¡œì íŠ¸ëª… ì…ë ¥" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        <button onclick="saveProject()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition">ì €ì¥</button>
                        <button onclick="loadProject()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    </div>
                </div>

                <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="flex border-b border-gray-700">
                        <button onclick="switchTab('basic')" id="tab-basic" class="flex-1 px-4 py-3 bg-blue-600 text-white font-semibold transition text-sm">
                            ğŸ“Š ê¸°ë³¸ ì„¤ì •
                        </button>
                        <button onclick="switchTab('wacc')" id="tab-wacc" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 transition text-sm">
                            ğŸ§® WACC
                        </button>
                        <button onclick="switchTab('scenario')" id="tab-scenario" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 transition text-sm">
                            ğŸ­ ì‹œë‚˜ë¦¬ì˜¤
                        </button>
                    </div>
                    
                    <!-- íƒ­ ë‚´ìš© -->
                    <div class="p-4">
                        <!-- ê¸°ë³¸ ì„¤ì • íƒ­ -->
                        <div id="content-basic" class="space-y-3">
                            <!-- ì—‘ì…€ ì—…ë¡œë“œ -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-green-300">ğŸ“Š ë§¤ì¶œ ë°ì´í„° ì—…ë¡œë“œ</h3>
                                <input type="file" id="excel-upload" accept=".xlsx, .xls" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-sm" onchange="handleExcelUpload(event)">
                                <p class="text-xs text-gray-400 mt-1">* ì—‘ì…€ íŒŒì¼ì—ì„œ ë§¤ì¶œ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì½ì–´ì˜µë‹ˆë‹¤</p>
                            </div>

                            <!-- CAGR ê¸°ë°˜ ë§¤ì¶œ ìƒì„± -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-yellow-300">ğŸ“ˆ CAGR ê¸°ë°˜ ë§¤ì¶œ ìƒì„±</h3>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="text-xs text-gray-300">ì´ˆê¸° ë§¤ì¶œ (ì–µì›)</label>
                                        <input type="number" id="initial-revenue" value="100" class="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-300">CAGR (%)</label>
                                        <input type="number" id="cagr" value="15" step="0.1" class="w-full px-2 py-1 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                    </div>
                                </div>
                                <button onclick="generateRevenue()" class="w-full px-3 py-2 bg-yellow-600 hover:bg-yellow-500 rounded-lg transition text-sm">ë§¤ì¶œ ìë™ ìƒì„±</button>
                            </div>

                            <!-- ê¸°ë³¸ ê°€ì • -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-purple-300">âš™ï¸ ê¸°ë³¸ ê°€ì •</h3>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-300">ì´ˆê¸° íˆ¬ìê¸ˆ (ì–µì›)</label>
                                            <input type="number" id="initial_investment" value="500" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-300">ë‚´ìš©ì—°ìˆ˜ (ë…„)</label>
                                            <input type="number" id="useful_life" value="10" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-300">ë¶„ì„ ê¸°ê°„ (ë…„)</label>
                                            <input type="number" id="analysis_period" value="10" min="1" max="20" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-300">ë²•ì¸ì„¸ìœ¨ (%)</label>
                                            <input type="number" id="tax_rate" value="25" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-300">ìš´ì „ìë³¸ ë¹„ìœ¨ (ë§¤ì¶œ ëŒ€ë¹„ %)</label>
                                        <input type="number" id="nwc_rate" value="10" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WACC íƒ­ -->
                        <div id="content-wacc" class="space-y-3 hidden">
                            <!-- ì‚°ì—…ë³„ ë¹ ë¥¸ ì ìš© -->
                            <div class="p-3 bg-gray-700 rounded-lg">
                                <label class="text-xs text-gray-300 block mb-2 font-semibold">ì‚°ì—…ë³„ ë¹ ë¥¸ ì ìš©</label>
                                <select id="industry-preset" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg text-sm" onchange="applyIndustryPreset()">
                                    <option value="">-- ì„ íƒ --</option>
                                    <option value="it">IT/ì†Œí”„íŠ¸ì›¨ì–´ (WACC ~8%)</option>
                                    <option value="manufacturing">ì œì¡°ì—… (WACC ~10%)</option>
                                    <option value="retail">ìœ í†µ/ì†Œë§¤ (WACC ~9%)</option>
                                    <option value="healthcare">í—¬ìŠ¤ì¼€ì–´ (WACC ~7%)</option>
                                    <option value="construction">ê±´ì„¤ (WACC ~11%)</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-300">í• ì¸ìœ¨ (WACC) (%)</label>
                                <input type="number" id="discount_rate" value="10" step="0.1" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg mt-1">
                            </div>
                            
                            <!-- WACC ìˆ˜ë™ ê³„ì‚° -->
                            <div class="bg-gray-700 p-3 rounded-lg space-y-2">
                                <h4 class="text-sm font-semibold text-blue-300">ğŸ“ WACC ì§ì ‘ ê³„ì‚°</h4>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-400">ë¶€ì±„ë¹„ì¤‘ D/(D+E) (%)</label>
                                        <input type="number" id="debt-weight" value="30" class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-400">íƒ€ì¸ìë³¸ë¹„ìš© (%)</label>
                                        <input type="number" id="cost-of-debt" value="5" step="0.1" class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm mt-1">
                                    </div>
                                </div>
                                
                                <!-- Beta ì¡°ì • -->
                                <div class="p-2 bg-gray-600 rounded-lg border border-blue-500">
                                    <p class="text-xs font-semibold text-blue-300 mb-2">ğŸ¯ Beta ì¡°ì • (Unlever â†’ Relever)</p>
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs text-gray-400">Unlevered Î²</label>
                                            <input type="number" id="unlevered-beta" value="0.8" step="0.01" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-400">ëª©í‘œ D/E (%)</label>
                                            <input type="number" id="target-de" value="40" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                        </div>
                                    </div>
                                    <button onclick="calculateReleverBeta()" class="w-full px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs transition">
                                        Levered Î² ê³„ì‚°
                                    </button>
                                </div>
                                
                                <!-- CAPM -->
                                <details class="bg-gray-600 p-2 rounded-lg">
                                    <summary class="cursor-pointer text-xs font-semibold text-green-300 mb-2">CAPM ê³„ì‚°</summary>
                                    <div class="space-y-2 mt-2">
                                        <div class="grid grid-cols-3 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-400">ë¬´ìœ„í—˜ì´ììœ¨ (%)</label>
                                                <input type="number" id="risk-free-rate" value="3.5" step="0.1" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-400">ì‹œì¥ìˆ˜ìµë¥  (%)</label>
                                                <input type="number" id="market-return" value="9" step="0.1" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-400">Beta (Î²)</label>
                                                <input type="number" id="beta" value="1.2" step="0.01" class="w-full px-2 py-1 bg-gray-700 border border-gray-500 rounded text-xs mt-1">
                                            </div>
                                        </div>
                                        <button onclick="calculateCAPM()" class="w-full px-2 py-1 bg-green-600 hover:bg-green-500 rounded text-xs transition">
                                            ìê¸°ìë³¸ë¹„ìš© ê³„ì‚°
                                        </button>
                                        <div id="capm-result" class="text-xs text-green-300"></div>
                                    </div>
                                </details>
                                
                                <div>
                                    <label class="text-xs text-gray-400">ìê¸°ìë³¸ë¹„ìš© (%)</label>
                                    <input type="number" id="cost-of-equity" value="12" step="0.1" class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded text-sm mt-1">
                                </div>
                                
                                <button onclick="calculateWACC()" class="w-full px-3 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg transition text-sm">
                                    WACC ê³„ì‚°
                                </button>
                                <div id="wacc-result" class="text-xs text-cyan-300"></div>
                                <div id="wacc-formula" class="text-xs text-gray-400 p-2 bg-gray-800 rounded"></div>
                            </div>
                        </div>

                        <!-- ì‹œë‚˜ë¦¬ì˜¤ íƒ­ -->
                        <div id="content-scenario" class="space-y-3 hidden">
                            <!-- ì”ì¡´ê°€ì¹˜ -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-orange-300">ğŸ’° ì”ì¡´ê°€ì¹˜ (Terminal Value)</h3>
                                <div class="mb-2">
                                    <label class="text-xs text-gray-300">ê³„ì‚° ë°©ë²•</label>
                                    <select id="tv-method" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm" onchange="toggleTVInputs()">
                                        <option value="liquidation">ì²­ì‚°ê°€ì¹˜</option>
                                        <option value="perpetual">ì˜êµ¬ì„±ì¥</option>
                                        <option value="exit-multiple">Exit Multiple</option>
                                    </select>
                                </div>
                                <div id="tv-inputs"></div>
                            </div>

                            <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
                            <div>
                                <h3 class="text-sm font-semibold mb-2 text-pink-300">ğŸ­ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="applyScenario('conservative')" class="px-3 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition text-sm">ë³´ìˆ˜ì </button>
                                    <button onclick="applyScenario('base')" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg transition text-sm">ê¸°ë³¸</button>
                                    <button onclick="applyScenario('optimistic')" class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded-lg transition text-sm">ë‚™ê´€ì </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ê³„ì‚° ë²„íŠ¼ -->
                <button onclick="calculate()" class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl text-lg font-bold transition shadow-lg">
                    ğŸš€ ë¶„ì„ ì‹œì‘
                </button>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ê²°ê³¼ íŒ¨ë„ -->
            <div class="col-span-7 space-y-4">
                
                <!-- KPI ì¹´ë“œ -->
                <div class="grid grid-cols-5 gap-3">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-blue-200">NPV</p>
                        <p id="npv-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-blue-200 mt-1">ì–µì›</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-600 to-green-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-green-200">IRR</p>
                        <p id="irr-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-green-200 mt-1">%</p>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-600 to-yellow-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-yellow-200">íšŒìˆ˜ê¸°ê°„</p>
                        <p id="payback-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-yellow-200 mt-1">ë…„</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-purple-200">ì†ìµë¶„ê¸°</p>
                        <p id="bep-value" class="text-2xl font-bold mt-1">-</p>
                        <p class="text-xs text-purple-200 mt-1">ë…„</p>
                    </div>
                    <div id="verdict-card" class="bg-gradient-to-br from-gray-600 to-gray-700 p-4 rounded-xl text-center">
                        <p class="text-sm text-gray-200">íŒì •</p>
                        <p id="verdict-value" class="text-2xl font-bold mt-1">-</p>
                    </div>
                </div>

                <!-- ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-red-300">ğŸ² ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜</h2>
                        <button onclick="runMonteCarloSimulation()" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition text-sm">
                            ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
                        </button>
                    </div>
                    <div class="chart-container-small">
                        <canvas id="monte-carlo-chart"></canvas>
                    </div>
                    <div id="mc-stats" class="grid grid-cols-4 gap-3 mt-3 text-center text-sm"></div>
                </div>

                <!-- ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµí‘œ -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">ğŸ“Š ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµ</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left">í•­ëª©</th>
                                    <th class="px-4 py-2 text-center">ë³´ìˆ˜ì </th>
                                    <th class="px-4 py-2 text-center">ê¸°ë³¸</th>
                                    <th class="px-4 py-2 text-center">ë‚™ê´€ì </th>
                                </tr>
                            </thead>
                            <tbody id="scenario-table-body" class="divide-y divide-gray-700">
                                <!-- ë™ì  ìƒì„± -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ë¯¼ê°ë„ ë¶„ì„ (1-Way) -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-yellow-300">ğŸ¯ ë¯¼ê°ë„ ë¶„ì„ (1-Way)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left">ë³€ìˆ˜</th>
                                    <th class="px-4 py-2 text-center">-20%</th>
                                    <th class="px-4 py-2 text-center">-10%</th>
                                    <th class="px-4 py-2 text-center">Base</th>
                                    <th class="px-4 py-2 text-center">+10%</th>
                                    <th class="px-4 py-2 text-center">+20%</th>
                                </tr>
                            </thead>
                            <tbody id="sensitivity-table-body" class="divide-y divide-gray-700">
                                <!-- ë™ì  ìƒì„± -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2-Way ë¯¼ê°ë„ ë¶„ì„ -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-orange-300">ğŸ¯ğŸ¯ 2-Way ë¯¼ê°ë„ ë¶„ì„ (ë§¤ì¶œ Ã— WACC)</h2>
                    <div class="overflow-x-auto">
                        <table id="sensitivity-2way-table" class="sensitivity-table w-full">
                            <!-- ë™ì  ìƒì„± -->
                        </table>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">* ë…¹ìƒ‰: NPV > 0 (íˆ¬ì ê°€ëŠ¥), ë¹¨ê°„ìƒ‰: NPV < 0 (íˆ¬ì ë¶ˆê°€)</p>
                </div>

                <!-- í˜„ê¸ˆíë¦„ ì°¨íŠ¸ -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-green-300">ğŸ“ˆ í˜„ê¸ˆíë¦„ ì°¨íŠ¸</h2>
                    <div class="chart-container">
                        <canvas id="cashflow-chart"></canvas>
                    </div>
                </div>

                <!-- ì—°ë„ë³„ FCF í…Œì´ë¸” -->
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h2 class="text-lg font-semibold mb-3 text-purple-300">ğŸ“‹ ì—°ë„ë³„ Free Cash Flow</h2>
                    <div class="overflow-x-auto table-scroll">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-700 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2">ì—°ë„</th>
                                    <th class="px-2 py-2">ë§¤ì¶œ</th>
                                    <th class="px-2 py-2">ì˜ì—…ì´ìµ</th>
                                    <th class="px-2 py-2">NOPAT</th>
                                    <th class="px-2 py-2">ê°ê°€ìƒê°</th>
                                    <th class="px-2 py-2">NWCì¦ê°€</th>
                                    <th class="px-2 py-2">FCF</th>
                                    <th class="px-2 py-2">í• ì¸FCF</th>
                                </tr>
                            </thead>
                            <tbody id="fcf-table-body" class="divide-y divide-gray-700 text-center">
                                <!-- ë™ì  ìƒì„± -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast ì•Œë¦¼ -->
    <div id="toast" class="fixed bottom-5 right-5 px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

    <script>
        let projectData = {
            revenues: [],
            margins: [],
            currentScenario: 'base',
            lastFCFData: []
        };

        let charts = {
            cashflow: null,
            monteCarlo: null
        };

        // Toast ì•Œë¦¼
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            } text-white transform translate-y-0 opacity-100`;
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            ['basic', 'wacc', 'scenario'].forEach(name => {
                const btn = document.getElementById(`tab-${name}`);
                const content = document.getElementById(`content-${name}`);
                
                if (name === tabName) {
                    btn.className = 'flex-1 px-4 py-3 bg-blue-600 text-white font-semibold transition text-sm';
                    content.classList.remove('hidden');
                } else {
                    btn.className = 'flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 transition text-sm';
                    content.classList.add('hidden');
                }
            });
        }

        // ë‹¤í¬ëª¨ë“œ í† ê¸€
        function toggleDarkMode() {
            document.body.classList.toggle('bg-gray-100');
            document.body.classList.toggle('text-gray-900');
            showToast('ë‹¤í¬ëª¨ë“œ ì „í™˜ë¨');
        }

        // TV ì…ë ¥ í•„ë“œ ë™ì  ë³€ê²½
        function toggleTVInputs() {
            const method = document.getElementById('tv-method').value;
            const container = document.getElementById('tv-inputs');
            
            if (method === 'liquidation') {
                container.innerHTML = `
                    <div>
                        <label class="text-xs text-gray-300">ì²­ì‚°ê°€ì¹˜ (ì–µì›)</label>
                        <input type="number" id="liquidation-value" value="100" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                    </div>
                `;
            } else if (method === 'perpetual') {
                container.innerHTML = `
                    <div>
                        <label class="text-xs text-gray-300">ì˜êµ¬ì„±ì¥ë¥  (g) (%)</label>
                        <input type="number" id="growth-rate" value="2" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                    </div>
                `;
            } else if (method === 'exit-multiple') {
                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-300">Exit Multiple</label>
                            <input type="number" id="exit-multiple" value="10" step="0.1" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-300">ê¸°ì¤€ ì§€í‘œ</label>
                            <select id="exit-metric" class="w-full px-2 py-1.5 bg-gray-700 border border-gray-600 rounded-lg mt-1 text-sm">
                                <option value="ebitda">EBITDA</option>
                                <option value="revenue">ë§¤ì¶œ</option>
                            </select>
                        </div>
                    </div>
                `;
            }
        }

        // ì´ˆê¸° TV ì…ë ¥ í•„ë“œ ì„¤ì •
        toggleTVInputs();

        // ì‚°ì—…ë³„ í”„ë¦¬ì…‹ ì ìš©
        function applyIndustryPreset() {
            const industry = document.getElementById('industry-preset').value;
            const presets = {
                'it': { wacc: 8, debtWeight: 10, costOfDebt: 4, costOfEquity: 8.5 },
                'manufacturing': { wacc: 10, debtWeight: 40, costOfDebt: 5, costOfEquity: 13 },
                'retail': { wacc: 9, debtWeight: 30, costOfDebt: 4.5, costOfEquity: 11 },
                'healthcare': { wacc: 7, debtWeight: 20, costOfDebt: 3.5, costOfEquity: 8 },
                'construction': { wacc: 11, debtWeight: 50, costOfDebt: 6, costOfEquity: 14 }
            };
            
            if (presets[industry]) {
                document.getElementById('discount_rate').value = presets[industry].wacc;
                document.getElementById('debt-weight').value = presets[industry].debtWeight;
                document.getElementById('cost-of-debt').value = presets[industry].costOfDebt;
                document.getElementById('cost-of-equity').value = presets[industry].costOfEquity;
                showToast(`${industry.toUpperCase()} ì‚°ì—… í”„ë¦¬ì…‹ ì ìš©ë¨`);
            }
        }

        // Beta ì¡°ì • ê³„ì‚° (Hamada Formula)
        function calculateReleverBeta() {
            const unleveredBeta = parseFloat(document.getElementById('unlevered-beta').value);
            const targetDE = parseFloat(document.getElementById('target-de').value) / 100;
            const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
            
            const leveredBeta = unleveredBeta * (1 + (1 - taxRate) * targetDE);
            
            document.getElementById('beta').value = leveredBeta.toFixed(2);
            showToast(`Levered Î² = ${leveredBeta.toFixed(2)}`);
        }

        // CAPM ê³„ì‚°
        function calculateCAPM() {
            const rf = parseFloat(document.getElementById('risk-free-rate').value) / 100;
            const rm = parseFloat(document.getElementById('market-return').value) / 100;
            const beta = parseFloat(document.getElementById('beta').value);
            
            const costOfEquity = rf + beta * (rm - rf);
            document.getElementById('cost-of-equity').value = (costOfEquity * 100).toFixed(2);
            
            document.getElementById('capm-result').innerHTML = `
                Re = ${(rf * 100).toFixed(1)}% + ${beta.toFixed(2)} Ã— (${(rm * 100).toFixed(1)}% - ${(rf * 100).toFixed(1)}%)
                = <strong>${(costOfEquity * 100).toFixed(2)}%</strong>
            `;
            
            showToast('ìê¸°ìë³¸ë¹„ìš© ê³„ì‚° ì™„ë£Œ');
        }

        // WACC ê³„ì‚°
        function calculateWACC() {
            const debtWeight = parseFloat(document.getElementById('debt-weight').value) / 100;
            const equityWeight = 1 - debtWeight;
            const costOfDebt = parseFloat(document.getElementById('cost-of-debt').value) / 100;
            const costOfEquity = parseFloat(document.getElementById('cost-of-equity').value) / 100;
            const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
            
            const wacc = (debtWeight * costOfDebt * (1 - taxRate)) + (equityWeight * costOfEquity);
            
            document.getElementById('discount_rate').value = (wacc * 100).toFixed(2);
            
            document.getElementById('wacc-formula').innerHTML = `
                <strong>WACC ê³„ì‚°:</strong><br>
                WACC = (D/(D+E) Ã— Rd Ã— (1-T)) + (E/(D+E) Ã— Re)<br>
                = (${(debtWeight * 100).toFixed(1)}% Ã— ${(costOfDebt * 100).toFixed(1)}% Ã— ${((1-taxRate) * 100).toFixed(0)}%) 
                + (${(equityWeight * 100).toFixed(1)}% Ã— ${(costOfEquity * 100).toFixed(1)}%)<br>
                = <strong style="color: #22d3ee;">${(wacc * 100).toFixed(2)}%</strong>
            `;
            
            document.getElementById('wacc-result').innerHTML = `ê³„ì‚° ê²°ê³¼: <strong>${(wacc * 100).toFixed(2)}%</strong>`;
            
            showToast('WACC ê³„ì‚° ì™„ë£Œ!');
        }

        // ì—‘ì…€ ì—…ë¡œë“œ
        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                projectData.revenues = jsonData.slice(1).map(row => parseFloat(row[0]) || 0);
                
                showToast('ì—‘ì…€ ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!');
                calculate();
            };
            reader.readAsArrayBuffer(file);
        }

        // CAGR ê¸°ë°˜ ë§¤ì¶œ ìƒì„±
        function generateRevenue() {
            const initialRevenue = parseFloat(document.getElementById('initial-revenue').value);
            const cagr = parseFloat(document.getElementById('cagr').value) / 100;
            const period = parseInt(document.getElementById('analysis_period').value);
            
            projectData.revenues = [];
            for (let i = 0; i < period; i++) {
                projectData.revenues.push(initialRevenue * Math.pow(1 + cagr, i));
            }
            
            showToast('ë§¤ì¶œ ë°ì´í„° ìƒì„± ì™„ë£Œ!');
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì ìš©
        function applyScenario(scenario) {
            const scenarios = {
                'conservative': { marginMultiplier: 0.8, wacc: 12 },
                'base': { marginMultiplier: 1.0, wacc: 10 },
                'optimistic': { marginMultiplier: 1.2, wacc: 8 }
            };
            
            const selected = scenarios[scenario];
            document.getElementById('discount_rate').value = selected.wacc;
            projectData.currentScenario = scenario;
            
            showToast(`${scenario === 'conservative' ? 'ë³´ìˆ˜ì ' : scenario === 'base' ? 'ê¸°ë³¸' : 'ë‚™ê´€ì '} ì‹œë‚˜ë¦¬ì˜¤ ì ìš©ë¨`);
            calculate();
        }

        // IRR ê³„ì‚° (ê°œì„ ëœ ìˆ˜ë ´ ë¡œì§)
        function calculateIRR(cashflows) {
            let low = -0.99, high = 5.0;
            const tolerance = 0.0001;
            const maxIterations = 200;
            
            for (let k = 0; k < maxIterations; k++) {
                let mid = (low + high) / 2;
                let npv = 0;
                
                cashflows.forEach((cf, i) => {
                    npv += cf / Math.pow(1 + mid, i);
                });
                
                if (Math.abs(npv) < tolerance) {
                    return mid * 100;
                }
                
                if (npv > 0) {
                    low = mid;
                } else {
                    high = mid;
                }
            }
            
            return ((low + high) / 2) * 100;
        }

        // ë¹ ë¥¸ NPV ê³„ì‚°
        function quickCalculateNPV() {
            const initialInvestment = parseFloat(document.getElementById('initial_investment').value);
            const period = parseInt(document.getElementById('analysis_period').value);
            const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
            const discountRate = parseFloat(document.getElementById('discount_rate').value) / 100;
            const nwcRate = parseFloat(document.getElementById('nwc_rate').value) / 100;
            
            const revenues = projectData.revenues.length > 0 ? projectData.revenues : 
                             Array.from({length: period}, (_, i) => {
                                 const initial = parseFloat(document.getElementById('initial-revenue').value);
                                 const cagr = parseFloat(document.getElementById('cagr').value) / 100;
                                 return initial * Math.pow(1 + cagr, i);
                             });
            
            let npv = -initialInvestment;
            let prevNWC = 0;
            const depreciation = initialInvestment / parseInt(document.getElementById('useful_life').value);
            
            for (let year = 1; year <= period; year++) {
                const revenue = revenues[year - 1] || 0;
                const operatingProfit = revenue * 0.2;
                const nopat = operatingProfit * (1 - taxRate);
                
                const currentNWC = revenue * nwcRate;
                const nwcIncrease = currentNWC - prevNWC;
                prevNWC = currentNWC;
                
                let fcf = nopat + depreciation - nwcIncrease;
                
                if (year === period) {
                    fcf += currentNWC;
                }
                
                npv += fcf / Math.pow(1 + discountRate, year);
            }
            
            return npv;
        }

        // ë©”ì¸ ê³„ì‚° í•¨ìˆ˜
        function calculate() {
            try {
                const initialInvestment = parseFloat(document.getElementById('initial_investment').value);
                const usefulLife = parseInt(document.getElementById('useful_life').value);
                const period = parseInt(document.getElementById('analysis_period').value);
                const taxRate = parseFloat(document.getElementById('tax_rate').value) / 100;
                const discountRate = parseFloat(document.getElementById('discount_rate').value) / 100;
                const nwcRate = parseFloat(document.getElementById('nwc_rate').value) / 100;
                
                if (projectData.revenues.length === 0) {
                    generateRevenue();
                }
                
                const depreciation = initialInvestment / usefulLife;
                
                const cashflows = [-initialInvestment];
                const fcfData = [];
                let prevNWC = 0;
                
                for (let year = 1; year <= period; year++) {
                    const revenue = projectData.revenues[year - 1] || 0;
                    const operatingMargin = 0.2;
                    const operatingProfit = revenue * operatingMargin;
                    const nopat = operatingProfit * (1 - taxRate);
                    
                    const currentNWC = revenue * nwcRate;
                    const nwcIncrease = currentNWC - prevNWC;
                    prevNWC = currentNWC;
                    
                    let fcf = nopat + depreciation - nwcIncrease;
                    
                    if (year === period) {
                        const tvMethod = document.getElementById('tv-method').value;
                        let residual = 0;
                        
                        if (tvMethod === 'liquidation') {
                            residual = parseFloat(document.getElementById('liquidation-value').value);
                        } else if (tvMethod === 'perpetual') {
                            const g = parseFloat(document.getElementById('growth-rate').value) / 100;
                            const normalizedFCF = nopat + depreciation;
                            const terminalValue = normalizedFCF * (1 + g) / (discountRate - g);
                            residual = terminalValue + currentNWC;
                        } else if (tvMethod === 'exit-multiple') {
                            const multiple = parseFloat(document.getElementById('exit-multiple').value);
                            const metric = document.getElementById('exit-metric').value;
                            residual = (metric === 'ebitda' ? operatingProfit : revenue) * multiple;
                        }
                        
                        fcf += residual;
                    }
                    
                    cashflows.push(fcf);
                    
                    const discountedFCF = fcf / Math.pow(1 + discountRate, year);
                    
                    fcfData.push({
                        year,
                        revenue,
                        operatingProfit,
                        nopat,
                        depreciation,
                        nwcIncrease,
                        fcf,
                        discountedFCF
                    });
                }
                
                projectData.lastFCFData = fcfData;
                
                const npv = cashflows.reduce((sum, cf, i) => sum + cf / Math.pow(1 + discountRate, i), 0);
                const irr = calculateIRR(cashflows);
                
                let cumulativeCF = -initialInvestment;
                let paybackPeriod = period;
                for (let i = 0; i < fcfData.length; i++) {
                    cumulativeCF += fcfData[i].fcf;
                    if (cumulativeCF >= 0) {
                        paybackPeriod = i + 1;
                        break;
                    }
                }
                
                // ì†ìµë¶„ê¸°ì  ê³„ì‚° (ëˆ„ì  ì˜ì—…ì´ìµì´ ì´ˆê¸°íˆ¬ìê¸ˆ íšŒìˆ˜)
                let cumulativeProfit = 0;
                let bep = period;
                for (let i = 0; i < fcfData.length; i++) {
                    // ì˜ì—…ì´ìµ ëˆ„ì  (NOPAT + ê°ê°€ìƒê°)
                    cumulativeProfit += fcfData[i].nopat + fcfData[i].depreciation;
                    
                    // ì´ˆê¸°íˆ¬ìê¸ˆ íšŒìˆ˜ ì—¬ë¶€ í™•ì¸
                    if (cumulativeProfit >= initialInvestment) {
                        bep = i + 1;
                        break;
                    }
                }
                
                document.getElementById('npv-value').textContent = npv.toFixed(1);
                document.getElementById('irr-value').textContent = irr.toFixed(2);
                document.getElementById('payback-value').textContent = paybackPeriod;
                document.getElementById('bep-value').textContent = bep;
                
                const verdict = npv > 0 && irr > discountRate * 100 ? 'âœ… íˆ¬ì ê°€ëŠ¥' : 'âŒ íˆ¬ì ë¶ˆê°€';
                const verdictCard = document.getElementById('verdict-card');
                document.getElementById('verdict-value').textContent = verdict;
                verdictCard.className = npv > 0 ? 
                    'bg-gradient-to-br from-green-600 to-green-700 p-4 rounded-xl text-center' :
                    'bg-gradient-to-br from-red-600 to-red-700 p-4 rounded-xl text-center';
                
                updateCashflowChart(fcfData);
                updateFCFTable(fcfData);
                updateScenarioComparison(npv, irr);
                calculate1WaySensitivity();
                calculate2WaySensitivity();
                
                showToast('ë¶„ì„ ì™„ë£Œ!', 'success');
                
            } catch (error) {
                console.error('ê³„ì‚° ì˜¤ë¥˜:', error);
                showToast('ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ë¹„êµí‘œ ì—…ë°ì´íŠ¸
        function updateScenarioComparison(baseNPV, baseIRR) {
            const scenarios = {
                'conservative': { margin: 0.85, wacc: 12 },
                'base': { margin: 1.0, wacc: 10 },
                'optimistic': { margin: 1.15, wacc: 8 }
            };
            
            const tbody = document.getElementById('scenario-table-body');
            tbody.innerHTML = '';
            
            const metrics = [
                { name: 'NPV (ì–µì›)', key: 'npv' },
                { name: 'IRR (%)', key: 'irr' },
                { name: 'íšŒìˆ˜ê¸°ê°„ (ë…„)', key: 'payback' }
            ];
            
            metrics.forEach(metric => {
                const row = document.createElement('tr');
                let cells = `<td class="px-4 py-2 font-semibold">${metric.name}</td>`;
                
                Object.keys(scenarios).forEach(scenario => {
                    const multiplier = scenarios[scenario].margin;
                    let value;
                    
                    if (metric.key === 'npv') {
                        value = (baseNPV * multiplier).toFixed(1);
                    } else if (metric.key === 'irr') {
                        value = (baseIRR * multiplier).toFixed(2);
                    } else {
                        value = Math.max(1, Math.floor(5 / multiplier));
                    }
                    
                    const color = parseFloat(value) > 0 ? 'text-green-400' : 'text-red-400';
                    cells += `<td class="px-4 py-2 text-center ${color}">${value}</td>`;
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        // 1-Way ë¯¼ê°ë„ ë¶„ì„
        function calculate1WaySensitivity() {
            const tbody = document.getElementById('sensitivity-table-body');
            tbody.innerHTML = '';
            
            const baseValues = {
                revenue: parseFloat(document.getElementById('initial-revenue').value),
                wacc: parseFloat(document.getElementById('discount_rate').value),
                nwcRate: parseFloat(document.getElementById('nwc_rate').value) / 100
            };
            
            const variables = [
                { name: 'ì´ˆê¸° ë§¤ì¶œ', field: 'revenue', id: 'initial-revenue' },
                { name: 'WACC', field: 'wacc', id: 'discount_rate' },
                { name: 'ìš´ì „ìë³¸ ë¹„ìœ¨', field: 'nwcRate', id: 'nwc_rate', isPercent: true }
            ];
            
            variables.forEach(variable => {
                const row = document.createElement('tr');
                const variations = [-0.2, -0.1, 0, 0.1, 0.2];
                
                let cells = `<td class="px-4 py-2">${variable.name}</td>`;
                
                variations.forEach(variation => {
                    const originalValue = document.getElementById(variable.id).value;
                    const adjustedValue = baseValues[variable.field] * (1 + variation);
                    
                    if (variable.isPercent) {
                        document.getElementById(variable.id).value = adjustedValue * 100;
                    } else {
                        document.getElementById(variable.id).value = adjustedValue;
                    }
                    
                    const npv = quickCalculateNPV();
                    
                    document.getElementById(variable.id).value = originalValue;
                    
                    const color = npv > 0 ? 'text-green-400' : 'text-red-400';
                    cells += `<td class="px-4 py-2 text-center ${color}">${npv.toFixed(1)}</td>`;
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        // 2-Way ë¯¼ê°ë„ ë¶„ì„
        function calculate2WaySensitivity() {
            const baseRevenue = parseFloat(document.getElementById('initial-revenue').value);
            const baseWACC = parseFloat(document.getElementById('discount_rate').value);
            
            const revenueVariations = [-0.2, -0.1, 0, 0.1, 0.2];
            const waccVariations = [-2, -1, 0, 1, 2];
            
            const table = document.getElementById('sensitivity-2way-table');
            table.innerHTML = '';
            
            let headerRow = '<tr><th>ë§¤ì¶œ \\ WACC</th>';
            waccVariations.forEach(wv => {
                const waccValue = (baseWACC + wv).toFixed(1);
                headerRow += `<th>${waccValue}%</th>`;
            });
            headerRow += '</tr>';
            table.innerHTML += headerRow;
            
            const originalRevenue = document.getElementById('initial-revenue').value;
            const originalWACC = document.getElementById('discount_rate').value;
            
            revenueVariations.forEach(rv => {
                const revenueValue = (baseRevenue * (1 + rv)).toFixed(0);
                let row = `<tr><td>${revenueValue}ì–µ</td>`;
                
                waccVariations.forEach(wv => {
                    document.getElementById('initial-revenue').value = baseRevenue * (1 + rv);
                    document.getElementById('discount_rate').value = baseWACC + wv;
                    
                    const npv = quickCalculateNPV();
                    
                    const cellClass = npv > 0 ? 'sensitivity-positive' : 'sensitivity-negative';
                    row += `<td class="${cellClass}">${npv.toFixed(0)}</td>`;
                });
                
                row += '</tr>';
                table.innerHTML += row;
            });
            
            document.getElementById('initial-revenue').value = originalRevenue;
            document.getElementById('discount_rate').value = originalWACC;
        }

        // í˜„ê¸ˆíë¦„ ì°¨íŠ¸
        function updateCashflowChart(fcfData) {
            const ctx = document.getElementById('cashflow-chart').getContext('2d');
            
            if (charts.cashflow) {
                charts.cashflow.destroy();
            }
            
            charts.cashflow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fcfData.map(d => `Y${d.year}`),
                    datasets: [{
                        label: 'FCF',
                        data: fcfData.map(d => d.fcf),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        // FCF í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateFCFTable(fcfData) {
            const tbody = document.getElementById('fcf-table-body');
            tbody.innerHTML = '';
            
            fcfData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-2 py-2">${data.year}</td>
                    <td class="px-2 py-2">${data.revenue.toFixed(1)}</td>
                    <td class="px-2 py-2">${data.operatingProfit.toFixed(1)}</td>
                    <td class="px-2 py-2">${data.nopat.toFixed(1)}</td>
                    <td class="px-2 py-2">${data.depreciation.toFixed(1)}</td>
                    <td class="px-2 py-2">${data.nwcIncrease.toFixed(1)}</td>
                    <td class="px-2 py-2 font-bold">${data.fcf.toFixed(1)}</td>
                    <td class="px-2 py-2 text-blue-400">${data.discountedFCF.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
        function runMonteCarloSimulation() {
            const simulations = 1000;
            const results = [];
            
            const originalRevenue = document.getElementById('initial-revenue').value;
            const originalWACC = document.getElementById('discount_rate').value;
            
            for (let i = 0; i < simulations; i++) {
                const randomRevenue = parseFloat(originalRevenue) * (0.8 + Math.random() * 0.4);
                const randomWACC = parseFloat(originalWACC) * (0.9 + Math.random() * 0.2);
                
                document.getElementById('initial-revenue').value = randomRevenue;
                document.getElementById('discount_rate').value = randomWACC;
                
                const npv = quickCalculateNPV();
                results.push(npv);
            }
            
            document.getElementById('initial-revenue').value = originalRevenue;
            document.getElementById('discount_rate').value = originalWACC;
            
            results.sort((a, b) => a - b);
            const mean = results.reduce((a, b) => a + b, 0) / results.length;
            const p10 = results[Math.floor(simulations * 0.1)];
            const p50 = results[Math.floor(simulations * 0.5)];
            const p90 = results[Math.floor(simulations * 0.9)];
            
            document.getElementById('mc-stats').innerHTML = `
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">í‰ê·  NPV</p>
                    <p class="text-base font-bold">${mean.toFixed(1)}</p>
                </div>
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">P10</p>
                    <p class="text-base font-bold">${p10.toFixed(1)}</p>
                </div>
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">P50</p>
                    <p class="text-base font-bold">${p50.toFixed(1)}</p>
                </div>
                <div class="bg-gray-700 p-2 rounded-lg">
                    <p class="text-xs text-gray-400">P90</p>
                    <p class="text-base font-bold">${p90.toFixed(1)}</p>
                </div>
            `;
            
            const ctx = document.getElementById('monte-carlo-chart').getContext('2d');
            if (charts.monteCarlo) {
                charts.monteCarlo.destroy();
            }
            
            const bins = 20;
            const binSize = (Math.max(...results) - Math.min(...results)) / bins;
            const histogram = new Array(bins).fill(0);
            
            results.forEach(r => {
                const binIndex = Math.min(Math.floor((r - Math.min(...results)) / binSize), bins - 1);
                histogram[binIndex]++;
            });
            
            charts.monteCarlo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: histogram.map((_, i) => ((Math.min(...results) + binSize * i)).toFixed(0)),
                    datasets: [{
                        label: 'ë¹ˆë„',
                        data: histogram,
                        backgroundColor: 'rgba(239, 68, 68, 0.6)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8', maxRotation: 45, minRotation: 45 }, grid: { color: '#334155' } }
                    }
                }
            });
            
            showToast('ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ!');
        }

        // í”„ë¡œì íŠ¸ ì €ì¥
        function saveProject() {
            const projectName = document.getElementById('project-name').value || 'untitled';
            const data = {
                name: projectName,
                revenues: projectData.revenues,
                margins: projectData.margins,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(`project_${projectName}`, JSON.stringify(data));
            showToast('í”„ë¡œì íŠ¸ ì €ì¥ ì™„ë£Œ!');
        }

        // í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadProject() {
            const projectName = document.getElementById('project-name').value;
            const data = localStorage.getItem(`project_${projectName}`);
            
            if (data) {
                const project = JSON.parse(data);
                projectData = project;
                showToast('í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
                calculate();
            } else {
                showToast('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        // í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ['ì—°ë„', 'ë§¤ì¶œ (ì–µì›)', 'ì˜ì—…ì´ìµë¥  (%)'],
                [1, 100, 20],
                [2, 120, 22],
                [3, 145, 23]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "ë§¤ì¶œ í…œí”Œë¦¿");
            XLSX.writeFile(wb, "íˆ¬ìë¶„ì„_í…œí”Œë¦¿.xlsx");
            
            showToast('í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        function downloadExcel() {
            const tbody = document.getElementById('fcf-table-body');
            if (!tbody || tbody.children.length === 0) {
                showToast('ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            const fcfData = [
                ['ì—°ë„', 'ë§¤ì¶œ', 'ì˜ì—…ì´ìµ', 'NOPAT', 'ê°ê°€ìƒê°', 'NWCì¦ê°€', 'FCF', 'í• ì¸FCF']
            ];
            
            Array.from(tbody.children).forEach(row => {
                const cells = Array.from(row.children).map(cell => cell.textContent.trim());
                fcfData.push(cells);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(fcfData);
            XLSX.utils.book_append_sheet(wb, ws1, "í˜„ê¸ˆíë¦„");
            
            const summaryData = [
                ['íˆ¬ì ê²½ì œì„± ë¶„ì„ ìš”ì•½'],
                [''],
                ['ì§€í‘œ', 'ê°’', 'ë‹¨ìœ„'],
                ['NPV', document.getElementById('npv-value').textContent, 'ì–µì›'],
                ['IRR', document.getElementById('irr-value').textContent, '%'],
                ['íšŒìˆ˜ê¸°ê°„', document.getElementById('payback-value').textContent, 'ë…„'],
                ['ì†ìµë¶„ê¸°', document.getElementById('bep-value').textContent, 'ë…„'],
                ['íŒì •', document.getElementById('verdict-value').textContent, '']
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, "ìš”ì•½");
            
            const projectName = document.getElementById('project-name').value || 'investment_analysis';
            XLSX.writeFile(wb, `${projectName}_ë¶„ì„ê²°ê³¼.xlsx`);
            
            showToast('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
        }

        // ê³µìœ 
        function shareResults() {
            const url = window.location.href;
            navigator.clipboard.writeText(url);
            showToast('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ì´ˆê¸° ì‹¤í–‰
        window.onload = function() {
            generateRevenue();
            showToast('ëŒ€ì‹œë³´ë“œ ì¤€ë¹„ ì™„ë£Œ!', 'info');
        };
    </script>
</body>
</html>